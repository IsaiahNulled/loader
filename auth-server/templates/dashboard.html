<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
    --bg:#0a0a0f;--bg2:#0d0d14;--surface:#12121c;--surface2:#1a1a28;--surface3:#22223a;
    --border:#1e1e35;--border2:#2a2a48;
    --text:#d0d0e0;--text2:#6a6a8a;--text3:#4a4a6a;
    --green:#a78bfa;--green2:#8b5cf6;--green3:#7c3aed;--green-dim:rgba(139,92,246,0.1);--green-dim2:rgba(139,92,246,0.15);
    --red:#f87171;--red-dim:rgba(248,113,113,0.12);
    --yellow:#facc15;--yellow-dim:rgba(250,204,21,0.12);
    --blue:#60a5fa;--blue-dim:rgba(96,165,250,0.12);
}
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
body{font-family:'Inter','Segoe UI',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px}
::selection{background:var(--green3);color:white}
.sidebar{background:rgba(18,18,28,0.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

/* ── Sidebar ── */
.sidebar{position:fixed;left:0;top:0;bottom:0;width:200px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:10}
.sidebar-brand{padding:20px 16px 16px;border-bottom:1px solid var(--border)}
.sidebar-brand .brand-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--green3),var(--green));border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:900;font-size:10px;color:white;margin-right:10px;vertical-align:middle}
.sidebar-brand .brand-text{font-weight:700;font-size:15px;color:var(--text);vertical-align:middle}
.sidebar-brand .brand-text span{color:var(--green)}
.sidebar-workspace{margin:12px 12px 0;padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;font-size:11px}
.sidebar-workspace .ws-label{color:var(--text3);text-transform:uppercase;letter-spacing:1px;font-size:9px;margin-bottom:3px}
.sidebar-workspace .ws-name{color:var(--text);font-weight:600;font-size:12px}
.sidebar-nav{flex:1;padding:16px 0}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;color:var(--text2);transition:all .15s;font-size:13px;border-left:2px solid transparent;margin:1px 0}
.nav-item:hover{color:var(--text);background:var(--surface2)}
.nav-item.active{color:var(--green);background:var(--green-dim);border-left-color:var(--green)}
.nav-item svg{width:16px;height:16px;opacity:.7}
.nav-item.active svg{opacity:1}
.sidebar-footer{padding:12px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text3)}
.sidebar-footer .status-dot{display:inline-block;width:6px;height:6px;background:var(--green);border-radius:50%;margin-right:6px;box-shadow:0 0 6px var(--green)}

/* ── Main ── */
.main{margin-left:200px;padding:24px 30px}
.page{display:none}.page.active{display:block}

/* ── Page Header ── */
.page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px}
.page-header h1{font-size:22px;font-weight:700;color:var(--text)}
.page-header p{font-size:13px;color:var(--text2);margin-top:4px}

/* ── Stats ── */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px 18px}
.stat-card .s-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px}
.stat-card .s-value{font-size:26px;font-weight:700}
.stat-card .s-sub{font-size:11px;color:var(--text3);margin-top:2px}
.s-green .s-value{color:var(--green)}.s-blue .s-value{color:var(--blue)}.s-yellow .s-value{color:var(--yellow)}.s-red .s-value{color:var(--red)}

/* ── Panel / Table ── */
.panel{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.toolbar{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid var(--border)}
.search-box{display:flex;align-items:center;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:0 10px;flex:1;max-width:320px}
.search-box svg{color:var(--text3);width:14px;height:14px;flex-shrink:0}
.search-box input{background:none;border:none;color:var(--text);padding:7px 8px;font-size:13px;outline:none;width:100%}
.search-box input::placeholder{color:var(--text3)}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:8px 16px;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);background:var(--bg2);font-weight:600}
td{padding:10px 16px;font-size:13px;border-bottom:1px solid var(--border);color:var(--text)}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(74,222,128,0.02)}
.table-footer{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-top:1px solid var(--border);font-size:12px;color:var(--text2)}
.table-footer .pager{display:flex;gap:4px}

/* ── Badges ── */
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-green{background:var(--green-dim2);color:var(--green)}
.badge-red{background:var(--red-dim);color:var(--red)}
.badge-yellow{background:var(--yellow-dim);color:var(--yellow)}
.badge-blue{background:var(--blue-dim);color:var(--blue)}
.badge-gray{background:rgba(100,120,100,0.15);color:var(--text2)}

/* ── Buttons ── */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:500;border:none;cursor:pointer;transition:all .12s;font-family:inherit}
.btn-green{background:var(--green3);color:white}.btn-green:hover{background:var(--green2)}
.btn-outline{background:transparent;color:var(--text2);border:1px solid var(--border)}.btn-outline:hover{background:var(--surface2);color:var(--text);border-color:var(--border2)}
.btn-danger{background:var(--red-dim);color:var(--red);border:1px solid rgba(248,113,113,0.2)}.btn-danger:hover{background:rgba(248,113,113,0.2)}
.btn-sm{padding:4px 10px;font-size:11px;border-radius:4px}
.btn-icon{padding:5px 7px;background:none;border:1px solid var(--border);color:var(--text2);border-radius:4px;cursor:pointer}.btn-icon:hover{background:var(--surface2);color:var(--text)}
.btn-icon svg{width:13px;height:13px}

/* ── Key text ── */
.key-text{font-family:'Consolas','Courier New',monospace;font-size:12px;color:var(--text);letter-spacing:0.3px}
.copy-wrap{display:inline-flex;align-items:center;gap:6px}
.copy-btn{background:none;border:none;color:var(--text3);cursor:pointer;padding:2px;border-radius:3px;display:inline-flex}.copy-btn:hover{color:var(--green)}
.copy-btn svg{width:13px;height:13px}

/* ── Actions menu ── */
.actions-cell{position:relative}
.actions-btn{background:none;border:none;color:var(--text2);cursor:pointer;padding:4px 8px;border-radius:4px;font-size:16px;line-height:1}
.actions-btn:hover{background:var(--surface2);color:var(--text)}
.actions-menu{display:none;position:absolute;right:16px;top:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:4px;z-index:50;min-width:140px;box-shadow:0 8px 24px rgba(0,0,0,0.4)}
.actions-menu.show{display:block}
.actions-menu button{display:flex;align-items:center;gap:8px;width:100%;padding:7px 10px;background:none;border:none;color:var(--text);cursor:pointer;font-size:12px;border-radius:4px;font-family:inherit;text-align:left}
.actions-menu button:hover{background:var(--surface3)}
.actions-menu button.danger{color:var(--red)}
.actions-menu button.danger:hover{background:var(--red-dim)}

/* ── Modal ── */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;justify-content:center;align-items:center;backdrop-filter:blur(2px)}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:24px;min-width:420px;max-width:480px;box-shadow:0 16px 48px rgba(0,0,0,0.5)}
.modal h3{font-size:16px;margin-bottom:16px;color:var(--text)}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:5px;font-weight:600}
.form-group input,.form-group select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;outline:none;font-family:inherit}
.form-group input:focus,.form-group select:focus{border-color:var(--green3)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:20px}

/* ── Toast ── */
.toast{position:fixed;bottom:20px;right:20px;padding:10px 18px;border-radius:6px;font-size:13px;z-index:200;animation:toastIn .3s;display:flex;align-items:center;gap:8px}
.toast-success{background:var(--green3);color:white}
.toast-error{background:rgba(220,50,50,0.95);color:white}
@keyframes toastIn{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}

/* ── Generated keys result ── */
.gen-result{margin-top:14px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:12px;font-family:'Consolas',monospace;font-size:12px;max-height:200px;overflow-y:auto;color:var(--green)}
.gen-result div{padding:3px 0;cursor:pointer;transition:color .1s}
.gen-result div:hover{color:white}

.empty-state{text-align:center;padding:40px;color:var(--text3);font-size:13px}

/* ── Discord user display ── */
.discord-user{display:flex;align-items:center;gap:8px}
.discord-avatar{width:26px;height:26px;border-radius:50%;border:2px solid var(--border2);object-fit:cover;flex-shrink:0}
.discord-name{font-size:12px;font-weight:500;color:var(--text)}
.discord-id-sub{font-size:10px;color:var(--text3);font-family:Consolas,monospace}

/* ── Nav badge ── */
.nav-badge{margin-left:auto;background:var(--green-dim2);color:var(--green);font-size:10px;padding:1px 6px;border-radius:10px;font-weight:600}

/* ── Responsive ── */
@media(max-width:1000px){.stats{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>

<!-- SVG Icons (hidden) -->
<svg style="display:none">
<symbol id="ico-grid" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></symbol>
<symbol id="ico-key" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></symbol>
<symbol id="ico-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></symbol>
<symbol id="ico-list" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></symbol>
<symbol id="ico-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></symbol>
<symbol id="ico-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
<symbol id="ico-more" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></symbol>
<symbol id="ico-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
<symbol id="ico-inject" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v6l3-3"/><path d="M12 8l-3-3"/><path d="M20 21v-4a2 2 0 0 0-2-2h-1.5"/><path d="M4 21v-4a2 2 0 0 1 2-2h1.5"/><circle cx="12" cy="16" r="4"/></symbol>
<symbol id="ico-skull" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="7"/><circle cx="9" cy="9" r="1.5" fill="currentColor"/><circle cx="15" cy="9" r="1.5" fill="currentColor"/><path d="M9 17v4h2v-2h2v2h2v-4"/><path d="M10 14h4"/></symbol>
<symbol id="ico-zap" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></symbol>
</svg>

<!-- Sidebar -->
<div class="sidebar">
    <div class="sidebar-brand">
        <span class="brand-icon">AP</span>
        <span class="brand-text">Admin <span>Panel</span></span>
    </div>
    <div class="sidebar-nav">
        <div class="nav-item active" data-page="dashboard"><svg><use href="#ico-grid"/></svg> Overview</div>
        <div class="nav-item" data-page="keys"><svg><use href="#ico-key"/></svg> Keys & Licenses</div>
        <div class="nav-item" data-page="sessions"><svg><use href="#ico-users"/></svg> Live Sessions <span class="nav-badge" id="nav-session-count">0</span></div>
        <div class="nav-item" data-page="injections"><svg><use href="#ico-zap"/></svg> Injection Logs</div>
        <div class="nav-item" data-page="logs"><svg><use href="#ico-list"/></svg> Auth Logs</div>
        <div class="nav-item" data-page="tokens"><svg><use href="#ico-inject"/></svg> Download Tokens</div>
        <div class="nav-item" data-page="monitor"><svg><use href="#ico-zap"/></svg> Monitor</div>
    </div>
    <div class="sidebar-footer"><span class="status-dot"></span>Server Online &nbsp;|&nbsp; <a href="/logout" style="color:var(--text3);text-decoration:none;font-size:11px">Logout</a></div>
    <div class="sidebar-footer" style="font-size:10px;color:var(--text3);padding-top:4px">Domain: <span id="public-domain">{{ domain }}</span></div>
</div>

<!-- Main Content -->
<div class="main">

    <!-- ═══ OVERVIEW ═══ -->
    <div class="page active" id="page-dashboard">
        <div class="page-header">
            <div><h1>Overview</h1><p>Monitor your authentication system at a glance</p></div>
        </div>
        <div class="stats">
            <div class="stat-card s-blue"><div class="s-label">Total Keys</div><div class="s-value" id="stat-total">-</div><div class="s-sub" id="stat-total-sub">loading...</div></div>
            <div class="stat-card s-green"><div class="s-label">Active Keys</div><div class="s-value" id="stat-active">-</div><div class="s-sub">Currently enabled</div></div>
            <div class="stat-card s-yellow"><div class="s-label">Live Sessions</div><div class="s-value" id="stat-sessions">-</div><div class="s-sub">Connected now</div></div>
            <div class="stat-card s-red"><div class="s-label">Expired</div><div class="s-value" id="stat-expired">-</div><div class="s-sub">Past expiry date</div></div>
        </div>
                <div class="panel">
            <div class="toolbar"><span style="font-weight:600;font-size:13px;color:var(--text)">Recent Activity</span></div>
            <table><thead><tr><th>Time</th><th>Action</th><th>License Key</th><th>IP</th><th>Status</th><th>Message</th></tr></thead>
            <tbody id="dash-logs"><tr><td colspan="6" class="empty-state">Loading...</td></tr></tbody></table>
        </div>
    </div>

    <!-- ═══ KEYS & LICENSES ═══ -->
    <div class="page" id="page-keys">
        <div class="page-header">
            <div><h1>Key Manager</h1><p>Generate, distribute, and track your software licenses</p></div>
            <button class="btn btn-green" onclick="openCreateModal()"><svg style="width:14px;height:14px"><use href="#ico-plus"/></svg> Generate Key</button>
        </div>
        <div class="panel">
            <div class="toolbar">
                <div class="search-box"><svg><use href="#ico-search"/></svg><input type="text" id="key-search" placeholder="Search by key, user, or HWID..." oninput="filterKeys()"></div>
                <select id="key-filter" onchange="filterKeys()" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--text);font-size:12px;cursor:pointer">
                    <option value="all">All Keys</option>
                    <option value="active">Active</option>
                    <option value="expired">Expired</option>
                    <option value="revoked">Revoked</option>
                    <option value="unbound">Unbound HWID</option>
                </select>
            </div>
            <table><thead><tr><th>License Key</th><th>Status</th><th>Assigned To</th><th>Hardware ID</th><th>Expiry Date</th><th style="width:40px">Actions</th></tr></thead>
            <tbody id="keys-table"><tr><td colspan="6" class="empty-state">Loading...</td></tr></tbody></table>
            <div class="table-footer">
                <span id="keys-count">Showing 0 entries</span>
                <div></div>
            </div>
        </div>
    </div>

    <!-- ═══ LIVE SESSIONS ═══ -->
    <div class="page" id="page-sessions">
        <div class="page-header">
            <div><h1>Live Sessions</h1><p>Monitor connected users — Terminate to force self-destruct + PC restart</p></div>
            <button class="btn btn-danger" onclick="killAllSessions()"><svg style="width:14px;height:14px"><use href="#ico-skull"/></svg> Kill All Sessions</button>
        </div>
        <div class="panel">
            <table><thead><tr><th>License Key</th><th>Discord User</th><th>Windows Email</th><th>HWID</th><th>IP</th><th>Last Seen</th><th>Status</th><th style="width:100px">Actions</th></tr></thead>
            <tbody id="sessions-table"><tr><td colspan="8" class="empty-state">Loading...</td></tr></tbody></table>
            <div class="table-footer"><span id="sessions-count">0 active sessions</span><div></div></div>
        </div>
    </div>

    <!-- ═══ INJECTION LOGS ═══ -->
    <div class="page" id="page-injections">
        <div class="page-header">
            <div><h1>Injection Logs</h1><p>Full history of driver injections with user identity</p></div>
            <select id="inject-log-limit" onchange="loadInjectionLogs()" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:7px 12px;color:var(--text);font-size:12px;cursor:pointer">
                <option value="25">Last 25</option>
                <option value="50" selected>Last 50</option>
                <option value="100">Last 100</option>
                <option value="250">Last 250</option>
            </select>
        </div>
        <div class="panel">
            <table><thead><tr><th>Time</th><th>License Key</th><th>Discord User</th><th>Windows Email</th><th>HWID</th><th>IP Address</th></tr></thead>
            <tbody id="inject-logs-table"><tr><td colspan="6" class="empty-state">Loading...</td></tr></tbody></table>
            <div class="table-footer"><span id="inject-logs-count">0 entries</span><div></div></div>
        </div>
    </div>

    <!-- ═══ AUTH LOGS ═══ -->
    <div class="page" id="page-logs">
        <div class="page-header">
            <div><h1>Auth Logs</h1><p>Track all authentication attempts and actions</p></div>
            <select id="log-limit" onchange="loadLogs()" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:7px 12px;color:var(--text);font-size:12px;cursor:pointer">
                <option value="25">Last 25</option>
                <option value="50" selected>Last 50</option>
                <option value="100">Last 100</option>
                <option value="250">Last 250</option>
            </select>
        </div>
        <div class="panel">
            <table><thead><tr><th>Time</th><th>Action</th><th>License Key</th><th>IP Address</th><th>Status</th><th>Details</th></tr></thead>
            <tbody id="logs-table"><tr><td colspan="6" class="empty-state">Loading...</td></tr></tbody></table>
            <div class="table-footer"><span id="logs-count">0 entries</span><div></div></div>
        </div>
    </div>

    <!-- ═══ DOWNLOAD TOKENS ═══ -->
    <div class="page" id="page-tokens">
        <div class="page-header">
            <div><h1>Download Tokens</h1><p>Track file download tokens issued to authenticated sessions</p></div>
            <select id="token-log-limit" onchange="loadTokens()" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:7px 12px;color:var(--text);font-size:12px;cursor:pointer">
                <option value="25">Last 25</option>
                <option value="50" selected>Last 50</option>
                <option value="100">Last 100</option>
                <option value="250">Last 250</option>
            </select>
        </div>
        <div class="panel">
            <table><thead><tr><th>Time</th><th>Token</th><th>License Key</th><th>Build</th><th>File</th><th>HWID</th><th>Status</th></tr></thead>
            <tbody id="tokens-table"><tr><td colspan="7" class="empty-state">Loading...</td></tr></tbody></table>
            <div class="table-footer"><span id="tokens-count">0 entries</span><div></div></div>
        </div>
    </div>

    <!-- ═══ MONITOR ═══ -->
    <div class="page" id="page-monitor">
        <div class="page-header">
            <div><h1>Session Monitor</h1><p>View client system information, running processes, and remote actions</p></div>
            <div style="display:flex;gap:8px;align-items:center">
                <select id="monitor-session-select" onchange="onMonitorSessionChange()" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:7px 12px;color:var(--text);font-size:12px;cursor:pointer;min-width:240px">
                    <option value="">— Select a session —</option>
                </select>
                <button onclick="requestMonitorData()" style="background:var(--accent);color:#fff;border:none;border-radius:6px;padding:7px 16px;font-size:12px;cursor:pointer;white-space:nowrap">Request Data</button>
            </div>
        </div>

        <!-- System Info Cards -->
        <div id="monitor-info" style="display:none">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px">
                <div class="stat-card"><div class="stat-label">Computer</div><div class="stat-value" id="mon-computer">—</div></div>
                <div class="stat-card"><div class="stat-label">OS</div><div class="stat-value" id="mon-os" style="font-size:13px">—</div></div>
                <div class="stat-card"><div class="stat-label">CPU</div><div class="stat-value" id="mon-cpu" style="font-size:13px">—</div></div>
                <div class="stat-card"><div class="stat-label">RAM</div><div class="stat-value" id="mon-ram">—</div></div>
                <div class="stat-card"><div class="stat-label">GPU</div><div class="stat-value" id="mon-gpu" style="font-size:13px">—</div></div>
                <div class="stat-card"><div class="stat-label">Active Window</div><div class="stat-value" id="mon-window" style="font-size:13px">—</div></div>
            </div>

            <!-- Branded Task Manager -->
            <div class="panel" style="margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)">
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="font-size:14px;font-weight:600;color:var(--text)">Process Manager</span>
                        <span class="badge badge-blue" id="mon-proc-count">0 processes</span>
                    </div>
                    <div style="display:flex;gap:8px">
                        <input type="text" id="mon-proc-filter" oninput="filterProcesses()" placeholder="Filter processes..." style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 10px;color:var(--text);font-size:11px;width:180px">
                    </div>
                </div>
                <div style="max-height:400px;overflow-y:auto">
                    <table>
                        <thead><tr><th>Name</th><th>PID</th><th>Memory (MB)</th><th>Threads</th></tr></thead>
                        <tbody id="mon-proc-table"><tr><td colspan="4" class="empty-state">Select a session and request data</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display:flex;gap:12px;align-items:center">
                <button onclick="requestMonitorData()" style="background:var(--accent);color:#fff;border:none;border-radius:6px;padding:8px 20px;font-size:12px;cursor:pointer">Refresh Data</button>
                <span id="mon-last-update" style="font-size:11px;color:var(--text3)">No data yet</span>
                <div style="flex:1"></div>
                <button onclick="confirmBSOD()" style="background:#dc2626;color:#fff;border:none;border-radius:6px;padding:8px 20px;font-size:12px;cursor:pointer;font-weight:600">⚠ BSOD</button>
            </div>
        </div>

        <div id="monitor-empty" class="panel" style="padding:40px;text-align:center">
            <p style="color:var(--text3);font-size:13px">Select an active session from the dropdown above, then click <strong>Request Data</strong> to view the client's system information and running processes.</p>
        </div>
    </div>
</div>

<!-- ═══ Generate Key Modal ═══ -->
<div class="modal-overlay" id="create-modal">
    <div class="modal">
        <h3>Generate License Keys</h3>
        <div class="form-row">
            <div class="form-group"><label>Duration (Days)</label><input type="number" id="gen-days" value="30" min="1"></div>
            <div class="form-group"><label>Count</label><input type="number" id="gen-count" value="1" min="1" max="100"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Prefix</label><input type="text" id="gen-prefix" value="EXT"></div>
            <div class="form-group"><label>Max Sessions</label><input type="number" id="gen-sessions" value="1" min="1"></div>
        </div>
        <div class="form-group"><label>Note / Label</label><input type="text" id="gen-note" placeholder="e.g. Customer name, batch label..."></div>
        <div id="gen-result" class="gen-result" style="display:none"></div>
        <div class="modal-actions">
            <button class="btn btn-outline" onclick="closeModal('create-modal')">Close</button>
            <button class="btn btn-green" onclick="generateKeys()">Generate</button>
        </div>
    </div>
</div>

<script>
let allKeys = [];
let openMenu = null;
const discordCache = {};  // {discord_id: {username, avatar_url}}

/* ── Discord user resolution ── */
async function resolveDiscord(discordId) {
    if (!discordId) return null;
    if (discordCache[discordId]) return discordCache[discordId];
    try {
        const r = await fetch('/api/admin/discord-user/' + discordId, { credentials: 'same-origin' });
        const data = await r.json();
        if (data.success) {
            discordCache[discordId] = { username: data.username, avatar_url: data.avatar_url };
            return discordCache[discordId];
        }
    } catch (e) {}
    // Fallback: cache the ID itself so we don't retry and don't stay on "Loading..."
    discordCache[discordId] = { username: discordId, avatar_url: '' };
    return discordCache[discordId];
}

function renderDiscordCell(discordId) {
    if (!discordId) return '<span style="color:var(--text3)">-</span>';
    const cached = discordCache[discordId];
    if (cached) {
        return `<div class="discord-user">
            <img class="discord-avatar" src="${cached.avatar_url}" onerror="this.style.display='none'">
            <div><div class="discord-name">${cached.username}</div><div class="discord-id-sub">${discordId}</div></div>
        </div>`;
    }
    return `<div class="discord-user" data-discord-id="${discordId}">
        <div style="width:26px;height:26px;border-radius:50%;background:var(--surface2);flex-shrink:0"></div>
        <div><div class="discord-name" style="color:var(--text2)">Loading...</div><div class="discord-id-sub">${discordId}</div></div>
    </div>`;
}

async function resolveAllDiscordInPage() {
    const els = document.querySelectorAll('[data-discord-id]');
    const ids = [...new Set([...els].map(el => el.dataset.discordId).filter(Boolean))];
    await Promise.all(ids.map(id => resolveDiscord(id)));
    els.forEach(el => {
        const id = el.dataset.discordId;
        const cached = discordCache[id];
        if (cached) {
            el.innerHTML = `<img class="discord-avatar" src="${cached.avatar_url}" onerror="this.style.display='none'">
                <div><div class="discord-name">${cached.username}</div><div class="discord-id-sub">${id}</div></div>`;
            el.removeAttribute('data-discord-id');
        }
    });
}

/* ── API helper (session-based auth — cookie sent automatically) ── */
async function api(method, path, data) {
    const opts = { method, headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin' };
    if (data) opts.body = JSON.stringify(data);
    try {
        const r = await fetch('/api/admin' + path, opts);
        if (r.status === 401) { window.location.href = '/login'; return null; }
        return await r.json();
    } catch (e) { toast('Connection error', 'error'); return null; }
}

/* ── Toast ── */
function toast(msg, type = 'success') {
    const t = document.createElement('div');
    t.className = 'toast toast-' + type;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

/* ── Navigation ── */
document.querySelectorAll('.nav-item').forEach(n => {
    n.addEventListener('click', () => {
        const page = n.dataset.page;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('page-' + page).classList.add('active');
        n.classList.add('active');
        if (page === 'dashboard') loadDashboard();
        if (page === 'keys') loadKeys();
        if (page === 'sessions') loadSessions();
        if (page === 'injections') loadInjectionLogs();
        if (page === 'logs') loadLogs();
        if (page === 'tokens') loadTokens();
        if (page === 'monitor') loadMonitorSessions();
    });
});

/* ── Helpers ── */
function fmtDate(iso) {
    if (!iso) return '-';
    const d = new Date(iso);
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    const date = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    return date + '  ' + time;
}

function fmtRelative(iso) {
    if (!iso) return '-';
    const d = new Date(iso);
    const diff = d - new Date();
    if (diff < 0) return 'Expired';
    const days = Math.floor(diff / 86400000);
    if (days > 30) return Math.floor(days/30) + ' months';
    if (days > 0) return days + ' days';
    const hrs = Math.floor(diff / 3600000);
    return hrs + ' hours';
}

function copyText(text) {
    navigator.clipboard.writeText(text);
    toast('Copied to clipboard');
}

function truncHwid(hwid) {
    if (!hwid) return '';
    if (hwid.length > 16) return 'HWID: ' + hwid.substring(0, 12) + '...';
    return 'HWID: ' + hwid;
}

/* ── Close menus on click outside ── */
document.addEventListener('click', (e) => {
    if (!e.target.closest('.actions-cell')) {
        document.querySelectorAll('.actions-menu.show').forEach(m => m.classList.remove('show'));
    }
});

function toggleMenu(el) {
    const menu = el.nextElementSibling;
    document.querySelectorAll('.actions-menu.show').forEach(m => { if (m !== menu) m.classList.remove('show'); });
    menu.classList.toggle('show');
}

/* ══════════════════════════════════════════════════════════════
 *  OVERVIEW
 * ══════════════════════════════════════════════════════════════ */
async function loadDashboard() {
    const [keys, sessions, logs] = await Promise.all([
        api('GET', '/keys'), api('GET', '/sessions'), api('GET', '/logs?limit=10')
    ]);
    if (keys?.keys) {
        const now = new Date();
        const active = keys.keys.filter(k => k.enabled && new Date(k.expires) > now);
        const expired = keys.keys.filter(k => new Date(k.expires) < now);
        document.getElementById('stat-total').textContent = keys.keys.length;
        document.getElementById('stat-total-sub').textContent = keys.keys.filter(k => k.hwid_bound).length + ' HWID bound';
        document.getElementById('stat-active').textContent = active.length;
        document.getElementById('stat-expired').textContent = expired.length;
    }
    if (sessions?.sessions) {
        document.getElementById('stat-sessions').textContent = sessions.sessions.length;
        document.getElementById('nav-session-count').textContent = sessions.sessions.length;
    }
    if (logs?.logs) {
        const tbody = document.getElementById('dash-logs');
        if (logs.logs.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No activity yet</td></tr>'; return; }
        tbody.innerHTML = logs.logs.map(l => `<tr>
            <td style="color:var(--text2);font-size:12px">${fmtDate(l.time)}</td>
            <td>${l.action}</td>
            <td><span class="key-text">${l.key || '-'}</span></td>
            <td style="color:var(--text2)">${l.ip || '-'}</td>
            <td>${l.success ? '<span class="badge badge-green">Success</span>' : '<span class="badge badge-red">Failed</span>'}</td>
            <td style="color:var(--text3);font-size:12px">${l.message || ''}</td>
        </tr>`).join('');
    }
}

/* ══════════════════════════════════════════════════════════════
 *  KEYS & LICENSES
 * ══════════════════════════════════════════════════════════════ */
async function loadKeys() {
    const r = await api('GET', '/keys');
    if (!r?.keys) return;
    allKeys = r.keys;
    filterKeys();
}

function filterKeys() {
    const search = (document.getElementById('key-search').value || '').toLowerCase();
    const filter = document.getElementById('key-filter').value;
    const now = new Date();

    let filtered = allKeys.filter(k => {
        if (search && !k.key.toLowerCase().includes(search) && !(k.note||'').toLowerCase().includes(search))
            return false;
        if (filter === 'active') return k.enabled && new Date(k.expires) > now;
        if (filter === 'expired') return new Date(k.expires) < now;
        if (filter === 'revoked') return !k.enabled;
        if (filter === 'unbound') return !k.hwid_bound;
        return true;
    });

    const tbody = document.getElementById('keys-table');
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No keys found</td></tr>';
        document.getElementById('keys-count').textContent = 'Showing 0 entries';
        return;
    }

    tbody.innerHTML = filtered.map(k => {
        const expired = new Date(k.expires) < now;
        const status = !k.enabled ? '<span class="badge badge-red">Revoked</span>' :
                       expired ? '<span class="badge badge-yellow">Expired</span>' :
                       '<span class="badge badge-green">Active</span>';
        const hwid = k.hwid_bound
            ? '<span style="font-size:11px;color:var(--text2);font-family:Consolas,monospace">HWID bound</span>'
            : '<span style="color:var(--text3)">Unbound</span>';
        const assignedTo = k.note || '<span style="color:var(--text3)">pending_assignment</span>';

        return `<tr>
            <td>
                <span class="copy-wrap">
                    <span class="key-text">${k.key}</span>
                    <button class="copy-btn" onclick="copyText('${k.key}')" title="Copy key"><svg><use href="#ico-copy"/></svg></button>
                </span>
            </td>
            <td>${status}</td>
            <td style="font-size:12px">${assignedTo}</td>
            <td>${hwid}</td>
            <td style="font-size:12px;color:var(--text2)">${fmtDate(k.expires)}</td>
            <td class="actions-cell">
                <button class="actions-btn" onclick="toggleMenu(this)"><svg style="width:16px;height:16px"><use href="#ico-more"/></svg></button>
                <div class="actions-menu">
                    <button onclick="resetHwid(${k.id})">Reset HWID</button>
                    <button onclick="extendKey(${k.id})">Extend Expiry</button>
                    ${k.enabled ? `<button class="danger" onclick="revokeKey(${k.id})">Revoke Key</button>` : ''}
                    <button class="danger" onclick="deleteKey(${k.id})">Delete Forever</button>
                </div>
            </td>
        </tr>`;
    }).join('');

    document.getElementById('keys-count').textContent = `Showing ${filtered.length} of ${allKeys.length} entries`;
}

async function revokeKey(id) {
    if (!confirm('Revoke this key? Active sessions will be killed.')) return;
    const r = await api('DELETE', '/keys/' + id);
    if (r?.success) { toast('Key revoked'); loadKeys(); } else toast(r?.message || 'Error', 'error');
}

async function resetHwid(id) {
    if (!confirm('Reset HWID binding? User will need to re-login.')) return;
    const r = await api('POST', '/keys/' + id + '/reset-hwid');
    if (r?.success) { toast('HWID reset'); loadKeys(); } else toast(r?.message || 'Error', 'error');
}

async function extendKey(id) {
    const days = prompt('Extend by how many days?', '30');
    if (!days) return;
    const r = await api('POST', '/keys/' + id + '/extend', { days: parseInt(days) });
    if (r?.success) { toast('Extended by ' + days + ' days'); loadKeys(); } else toast(r?.message || 'Error', 'error');
}

async function deleteKey(id) {
    if (!confirm('PERMANENTLY DELETE this key?\n\nThis will remove:\n• The license key\n• All sessions\n• All injection logs\n• All auth logs\n\nThis cannot be undone.')) return;
    const r = await api('DELETE', '/keys/' + id + '/delete');
    if (r?.success) { toast('Key permanently deleted'); loadKeys(); } else toast(r?.message || 'Error', 'error');
}

function openCreateModal() {
    document.getElementById('gen-result').style.display = 'none';
    document.getElementById('create-modal').classList.add('show');
}
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

async function generateKeys() {
    const r = await api('POST', '/keys', {
        days: parseInt(document.getElementById('gen-days').value),
        count: parseInt(document.getElementById('gen-count').value),
        prefix: document.getElementById('gen-prefix').value,
        max_sessions: parseInt(document.getElementById('gen-sessions').value),
        note: document.getElementById('gen-note').value,
    });
    if (r?.keys) {
        const el = document.getElementById('gen-result');
        el.style.display = 'block';
        el.innerHTML = r.keys.map(k => `<div onclick="copyText('${k}')">${k}</div>`).join('');
        toast(r.keys.length + ' key(s) generated');
        loadKeys();
    } else toast(r?.message || 'Error', 'error');
}

/* ══════════════════════════════════════════════════════════════
 *  LIVE SESSIONS
 * ══════════════════════════════════════════════════════════════ */
async function loadSessions() {
    const r = await api('GET', '/sessions');
    if (!r?.sessions) return;
    const count = r.sessions.length;
    document.getElementById('nav-session-count').textContent = count;
    const tbody = document.getElementById('sessions-table');
    if (count === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No active sessions</td></tr>';
        document.getElementById('sessions-count').textContent = '0 active sessions';
        return;
    }
    tbody.innerHTML = r.sessions.map(s => {
        const statusBadge = s.kill_pending
            ? '<span class="badge badge-red">KILL PENDING</span>'
            : '<span class="badge badge-green">Active</span>';
        const terminateBtn = s.kill_pending
            ? '<span style="font-size:11px;color:var(--text3)">Awaiting heartbeat...</span>'
            : `<button class="btn btn-danger btn-sm" onclick="terminateSession('${s.session_id}')"><svg style="width:12px;height:12px"><use href="#ico-skull"/></svg> Terminate</button>`;
        return `<tr>
            <td><span class="copy-wrap"><span class="key-text">${s.license}</span><button class="copy-btn" onclick="copyText('${s.license}')"><svg><use href="#ico-copy"/></svg></button></span></td>
            <td>${renderDiscordCell(s.discord_id)}</td>
            <td style="font-size:12px;color:var(--text2)">${s.windows_email || '-'}</td>
            <td><span class="copy-wrap"><span style="font-size:11px;color:var(--text2);font-family:Consolas,monospace">${s.hwid || '-'}</span>${s.hwid ? `<button class="copy-btn" onclick="copyText('${s.hwid}')"><svg><use href="#ico-copy"/></svg></button>` : ''}</span></td>
            <td style="color:var(--text2);font-size:12px">${s.ip}</td>
            <td style="font-size:11px;color:var(--text3)">${fmtDate(s.last_seen)}</td>
            <td>${statusBadge}</td>
            <td>${terminateBtn}</td>
        </tr>`;
    }).join('');
    document.getElementById('sessions-count').textContent = count + ' active session' + (count !== 1 ? 's' : '');
    resolveAllDiscordInPage();
}

async function terminateSession(sessionId) {
    if (!confirm('TERMINATE this session?\n\nThis will:\n• Force-close their loader\n• Delete their loader files\n• Restart their PC\n\nThis action cannot be undone.')) return;
    const r = await api('POST', '/sessions/terminate', { session_id: sessionId });
    if (r?.success) {
        toast('Kill command issued — will execute on next heartbeat');
        loadSessions();
    } else {
        toast(r?.message || 'Error', 'error');
    }
}

async function killAllSessions() {
    if (!confirm('Kill ALL active sessions? All connected users will be disconnected.\n\n(This disconnects only — use individual Terminate for self-destruct)')) return;
    const r = await api('POST', '/sessions/kill', {});
    if (r?.success) { toast('All sessions killed'); loadSessions(); } else toast(r?.message || 'Error', 'error');
}

/* ══════════════════════════════════════════════════════════════
 *  INJECTION LOGS
 * ══════════════════════════════════════════════════════════════ */
async function loadInjectionLogs() {
    const limit = document.getElementById('inject-log-limit').value;
    const r = await api('GET', '/injection-logs?limit=' + limit);
    if (!r?.logs) return;
    const tbody = document.getElementById('inject-logs-table');
    if (r.logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No injection logs yet</td></tr>';
        document.getElementById('inject-logs-count').textContent = '0 entries';
        return;
    }
    tbody.innerHTML = r.logs.map(l => `<tr>
        <td style="font-size:12px;color:var(--text2)">${fmtDate(l.time)}</td>
        <td><span class="copy-wrap"><span class="key-text">${l.key || '-'}</span><button class="copy-btn" onclick="copyText('${l.key}')"><svg><use href="#ico-copy"/></svg></button></span></td>
        <td>${renderDiscordCell(l.discord_id)}</td>
        <td style="font-size:12px;color:var(--text2)">${l.windows_email || '-'}</td>
        <td><span style="font-size:11px;color:var(--text2);font-family:Consolas,monospace">${l.hwid || '-'}</span></td>
        <td style="color:var(--text2);font-size:12px">${l.ip || '-'}</td>
    </tr>`).join('');
    document.getElementById('inject-logs-count').textContent = r.logs.length + ' entries';
    resolveAllDiscordInPage();
}

/* ══════════════════════════════════════════════════════════════
 *  AUTH LOGS
 * ══════════════════════════════════════════════════════════════ */
async function loadLogs() {
    const limit = document.getElementById('log-limit').value;
    const r = await api('GET', '/logs?limit=' + limit);
    if (!r?.logs) return;
    const tbody = document.getElementById('logs-table');
    if (r.logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No logs yet</td></tr>';
        document.getElementById('logs-count').textContent = '0 entries';
        return;
    }
    tbody.innerHTML = r.logs.map(l => `<tr>
        <td style="font-size:12px;color:var(--text2)">${fmtDate(l.time)}</td>
        <td>${l.action}</td>
        <td><span class="key-text">${l.key || '-'}</span></td>
        <td style="color:var(--text2)">${l.ip || '-'}</td>
        <td>${l.success ? '<span class="badge badge-green">Success</span>' : '<span class="badge badge-red">Failed</span>'}</td>
        <td style="color:var(--text3);font-size:12px">${l.message || ''}</td>
    </tr>`).join('');
    document.getElementById('logs-count').textContent = r.logs.length + ' entries';
}


/* ══════════════════════════════════════════════════════════════
 *  DOWNLOAD TOKENS
 * ══════════════════════════════════════════════════════════════ */
async function loadTokens() {
    const limit = document.getElementById('token-log-limit').value;
    const r = await api('GET', '/download-tokens?limit=' + limit);
    if (!r?.tokens) return;
    const tbody = document.getElementById('tokens-table');
    if (r.tokens.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No download tokens yet</td></tr>';
        document.getElementById('tokens-count').textContent = '0 entries';
        return;
    }
    tbody.innerHTML = r.tokens.map(t => {
        const statusBadge = t.status === 'used' ? '<span class="badge badge-green">Used</span>'
            : t.status === 'expired' ? '<span class="badge badge-yellow">Expired</span>'
            : '<span class="badge badge-blue">Active</span>';
        const buildBadge = t.build === 'full' ? '<span class="badge badge-green">Full</span>'
            : '<span class="badge badge-blue">Safe</span>';
        return `<tr>
            <td style="font-size:12px;color:var(--text2)">${fmtDate(t.created)}</td>
            <td><span class="key-text">${t.token}</span></td>
            <td><span class="key-text">${t.license}</span></td>
            <td>${buildBadge}</td>
            <td style="font-size:12px">${t.file_type}</td>
            <td><span style="font-size:11px;color:var(--text2);font-family:Consolas,monospace">${t.hwid}</span></td>
            <td>${statusBadge}</td>
        </tr>`;
    }).join('');
    document.getElementById('tokens-count').textContent = r.tokens.length + ' entries';
}

/* ══════════════════════════════════════════════════════════════
 *  MONITOR
 * ══════════════════════════════════════════════════════════════ */
let monitorProcesses = [];
let monitorSessionId = '';
let monitorPolling = null;

async function loadMonitorSessions() {
    const r = await api('GET', '/sessions');
    if (!r?.sessions) return;
    const sel = document.getElementById('monitor-session-select');
    const prev = sel.value;
    sel.innerHTML = '<option value="">— Select a session —</option>';
    r.sessions.forEach(s => {
        const label = `${s.key.substring(0,20)}... | ${s.ip} | ${fmtDate(s.last_seen)}`;
        sel.innerHTML += `<option value="${s.id}">${label}</option>`;
    });
    if (prev) sel.value = prev;
}

function onMonitorSessionChange() {
    const sid = document.getElementById('monitor-session-select').value;
    monitorSessionId = sid;
    if (!sid) {
        document.getElementById('monitor-info').style.display = 'none';
        document.getElementById('monitor-empty').style.display = '';
        stopMonitorPolling();
        return;
    }
    document.getElementById('monitor-info').style.display = '';
    document.getElementById('monitor-empty').style.display = 'none';
    fetchMonitorData(sid);
}

async function requestMonitorData() {
    const sid = document.getElementById('monitor-session-select').value;
    if (!sid) { toast('Select a session first', 'error'); return; }
    monitorSessionId = sid;
    const r = await api('POST', '/monitor/request', { session_id: sid });
    if (r?.success) {
        toast('Monitor request sent — waiting for client response...');
        document.getElementById('monitor-info').style.display = '';
        document.getElementById('monitor-empty').style.display = 'none';
        startMonitorPolling(sid);
    } else {
        toast(r?.message || 'Failed to send monitor request', 'error');
    }
}

function startMonitorPolling(sid) {
    stopMonitorPolling();
    let attempts = 0;
    monitorPolling = setInterval(async () => {
        attempts++;
        await fetchMonitorData(sid);
        if (attempts > 12) stopMonitorPolling();
    }, 3000);
}

function stopMonitorPolling() {
    if (monitorPolling) { clearInterval(monitorPolling); monitorPolling = null; }
}

async function fetchMonitorData(sid) {
    const r = await fetch('/api/admin/monitor/' + sid, { credentials: 'same-origin' });
    if (r.status === 401) { window.location.href = '/login'; return; }
    const data = await r.json();
    if (!data?.success) return;
    stopMonitorPolling();
    renderMonitorData(data.data, data.timestamp);
}

function renderMonitorData(d, ts) {
    document.getElementById('mon-computer').textContent = d.computer || '—';
    document.getElementById('mon-os').textContent = d.os || '—';
    document.getElementById('mon-cpu').textContent = d.cpu || '—';
    document.getElementById('mon-ram').textContent = d.ram_used ? `${d.ram_used} / ${d.ram_total} MB` : '—';
    document.getElementById('mon-gpu').textContent = d.gpu || '—';
    document.getElementById('mon-window').textContent = d.active_window || '—';
    document.getElementById('mon-last-update').textContent = 'Last update: ' + fmtDate(new Date(ts * 1000).toISOString());

    monitorProcesses = d.processes || [];
    document.getElementById('mon-proc-count').textContent = monitorProcesses.length + ' processes';
    renderProcessTable(monitorProcesses);
}

function renderProcessTable(procs) {
    const tbody = document.getElementById('mon-proc-table');
    if (!procs.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No process data</td></tr>';
        return;
    }
    const sorted = [...procs].sort((a, b) => (b.mem || 0) - (a.mem || 0));
    tbody.innerHTML = sorted.map(p => {
        const memMB = p.mem ? (p.mem / 1024 / 1024).toFixed(1) : '0.0';
        return `<tr>
            <td style="font-size:12px;font-weight:500">${escHtml(p.name)}</td>
            <td style="font-size:11px;color:var(--text2)">${p.pid}</td>
            <td style="font-size:11px">${memMB}</td>
            <td style="font-size:11px;color:var(--text2)">${p.threads || '-'}</td>
        </tr>`;
    }).join('');
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function filterProcesses() {
    const q = document.getElementById('mon-proc-filter').value.toLowerCase();
    const filtered = q ? monitorProcesses.filter(p => p.name.toLowerCase().includes(q)) : monitorProcesses;
    renderProcessTable(filtered);
}

async function confirmBSOD() {
    const sid = document.getElementById('monitor-session-select').value;
    if (!sid) { toast('Select a session first', 'error'); return; }
    const confirmed = confirm('WARNING: This will cause a Blue Screen of Death (BSOD) on the client machine.\n\nThis action is IRREVERSIBLE and will crash their system immediately.\n\nAre you absolutely sure?');
    if (!confirmed) return;
    const doubleConfirm = confirm('FINAL CONFIRMATION:\n\nType OK to trigger BSOD on this session.\n\nThis CANNOT be undone.');
    if (!doubleConfirm) return;
    const r = await api('POST', '/bsod', { session_id: sid });
    if (r?.success) {
        toast('BSOD command queued — will execute on next heartbeat', 'success');
    } else {
        toast(r?.message || 'Failed to send BSOD command', 'error');
    }
}

/* ── Modal close on overlay click ── */
document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('show'); });
});

/* ── Init + Auto-refresh ── */
loadDashboard();
setInterval(() => {
    const active = document.querySelector('.page.active');
    if (active?.id === 'page-dashboard') loadDashboard();
    if (active?.id === 'page-sessions') loadSessions();
    if (active?.id === 'page-injections') loadInjectionLogs();
    if (active?.id === 'page-tokens') loadTokens();
    if (active?.id === 'page-monitor') loadMonitorSessions();
}, 10000);
</script>
</body>
</html>
